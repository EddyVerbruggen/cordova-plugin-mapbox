<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta name="msapplication-tap-highlight" content="no"/>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"/>
  <link rel="stylesheet" type="text/css" href="css/index.css"/>
  <title>Mapbox test</title>
</head>
<body>
<div class="app">
  <h1>Mapbox testMapbox testMapbox testMapbox testMapbox testMapbox testMapbox testMapbox testMapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>
  <h1>Mapbox test</h1>

  <div id="deviceready" class="blink">
    <p class="event listening">Connecting to Device</p>
    <p class="event received">Device is Ready</p>
    <br/>
    <br/>
    <button onclick="showMap(document.getElementById('mapId'))">Display map in a div</button>
  </div>
  <div id="mapId" style="bottom:0; top:50%;">
    <button onclick="flyTo()">Camera</button>
    <button onclick="addMarkers()">Markers</button>
    <button onclick="hideMap()">hide</button><br/><br/>
    <button onclick="getZoom()">getZoom</button>
    <button onclick="zoomIn()">zoom +</button>
    <button onclick="zoomOut()">zoom -</button><br/><br/>
    <button onclick="setCenter()">set center</button>
    <button onclick="getCenter()">get center</button>
    <button onclick="setPitch()">set pitch</button>
    <button onclick="getPitch()">get pitch</button><br/><br/>
    <button onclick="screen2Coords({'x': window.innerWidth/2,'y': window.innerHeight/2})">ctr2coords</button>
    <button onclick="coords2Screen({'lat': 52.3732160,'lng': 4.8941680})">ctr2screen</button>
    <button onclick="getBounds()">get bounds</button>
    <button onclick="toggleClickable()">Set map clickable</button>
    <button onclick="addOverlayDiv()">Add new DOM overlay element</button>
    <button onclick="deleteOverlayDiv()">Remove a DOM overlay element</button>
  </div>
</div>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script>
  var zoom = 10;

  var clickable = true;

  function toggleClickable() {
    clickable ^= true;
    Mapbox.setClickable(clickable)
  }

  function getBounds(){
    Meteor.getBounds(function (r) {
      alert(r);
    });
  }

  function addOverlayDiv(){
    var newDummy = document.createElement("span");
    newDummy.className = "dummy";
    newDummy.setAttribute("style", "float:left;width:20px;height:20px;background-color:red");

    var lastDummy = document.getElementsByClassName("dummy")[0];

    if (lastDummy){
      lastDummy.parentElement.appendChild(newDummy);
    } else {
      document.getElementById('mapId').appendChild(newDummy);
    }

    Mapbox.refreshMap({div:document.getElementById('mapId')});
  }

  function deleteOverlayDiv(){
    var elem = document.getElementsByClassName('dummy')[0];
    if (!elem) return;
    elem.parentNode.removeChild(elem);
    Mapbox.refreshMap({div:document.getElementById('mapId')});
  }

  function setCenter() {
    Mapbox.setCenter([5.2344, 50.2222]); //[long, lat]
  }

  function getCenter() {
    Mapbox.getCenter(function (c) {
      alert(c)
    },
    function (err) {
      alert(err)
    });
  }

  function setPitch() {
    Mapbox.setPitch(45);
  }

  function getPitch() {
    Mapbox.getPitch(function (p) {
      alert(p)
    });
  }

  function getZoom() {
    Mapbox.getZoom(function (z) {
      alert(z)
    });
  }

  function zoomIn() {
    Mapbox.zoomTo(++zoom);
  }

  function zoomOut() {
    Mapbox.setZoom(--zoom);
  }

  function showMap(div) {
    Mapbox.show({
              div: div || null,
              style: 'emerald',
              cameraPosition:{
                // Sets the center of the map to Maracanã
                target: {
                  lat: 52.3702160,
                  lng: 4.8951680
                },
                zoom: 4, // Android, zoomLevel
                bearing: 270, // Sets the orientation of the camera to look west
                tilt: 40, // // Sets the tilt of the camera to 30 degrees
                duration: 10 // in seconds
              },
              zoomLevel: zoom, // 0 (the entire world) to 20, default 10
              showUserLocation: true, // default false
              hideAttribution: true, // default false
              hideLogo: true, // default false
              hideCompass: false, // default false
              disableRotation: false, // default false
              disableScroll: false, // default false
              disableTilt: false, // default false
              disableZoom: false, // default false
              disablePitch: false, // default false
            },
            function (result) {
              // let's add callbacks for region changing
              //
              // - invoked when the map is about to moved (animated or not).
              Mapbox.onRegionWillChange(function(centerCoordinates) {
                console.log("Map will move from: ", centerCoordinates);
              });
              // - invoked at each tick (so 60 per second) when the map moves. So don't do any heavy computing here.
              Mapbox.onRegionIsChanging(function(centerCoordinates){
                console.log("New map center is: ", centerCoordinates);
              });
              // - invoked after the map has moved (animated or not).
              Mapbox.onRegionDidChange(function(centerCoordinates) {
                console.log("Map as finished to move to : ", centerCoordinates);
              });
            },
            function (error) {
              alert(error);
            }
    )
  }

  function hideMap() {
    Mapbox.hide({},
            function (result) {
              console.log(JSON.parse(result));
            },
            function (error) {
              alert(error);
            }
    )
  }

  function flyTo() {
    Mapbox.flyTo({
      cameraPosition:{
        // Sets the center of the map to Maracanã
        target: {
          lat: 52.3632160,
          lng: 4.9011680
        },
        zoom: 17, // Android, zoomLevel
        bearing: 270, // Sets the orientation of the camera to look west
        tilt: 40, // // Sets the tilt of the camera to 30 degrees
        duration: 10 // in seconds
      }
    });
  }

  function addMarkers() {
    Mapbox.addSource("markers", {
        "type": "geojson",
        "data": {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.8891680, 52.3602160]
                },
                "properties": {
                    "noIcon": true,
                    "title": "Mapbox DC",
                    "marker-symbol": "monument"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.8911680, 52.3702160]
                },
                "properties": {
                    "title": "Mapbox SF",
                    "marker-symbol": "harbor"
                }
            }]
          }
        },
      function (result) {
        console.log("hdf");
      },
      function (error) {
        alert("oijkl")
      }
    )
  }


  function coords2Screen(coords) {
    Mapbox.convertCoordinates(coords,
            function (point) {
              try{
                point = JSON.parse(point);
                alert("x:"+point.x+" - y:"+point.y);
              } catch (e){
                alert(e);
                console.log(e);
              }
            },
            function (error) {
              alert(error)
            })
  }

  function screen2Coords(point){
    Mapbox.convertPoint({
              'x':point.x,
              'y':point.y
            },
            function (latlng) {
              try{
                latlng = JSON.parse(latlng);
                alert("lat:"+latlng.lat+" - lng:"+latlng.lng);
              } catch (e) {
                alert(e);
                console.log(e);
              }
            },
            function (error) {
              alert(error)
            })
  }

</script>
</body>
</html>